#!/usr/bin/env bash

set -eo pipefail

get_download_url() {
  local install_type=$1
  local version=$2

  echo "https://github.com/php/php-src/archive/php-${version}.tar.gz"
}

get_php_version() {
  IFS='-' read -r -a version_info <<<"$1"

  if [ "${#version_info[@]}" -eq 1 ]; then
    echo "${version_info[0]}"
  else
    echo "${version_info[0]}-${version_info[1]}"
  fi
}

download_source() {
  local install_type=$1
  local version=$2
  local download_path=$3

  # Clean download directory to prevent extraction errors on retry
  if [ -d "$download_path" ]; then
    rm -rf "${download_path:?}"/*
  fi
  mkdir -p "$download_path"

  # Resolve "latest" to actual version number
  if [ "$version" = "latest" ]; then
    local script_dir
    script_dir=$(dirname "${BASH_SOURCE[0]}")
    version=$("$script_dir/latest-stable")
    echo "Resolved 'latest' to version $version"
  fi

  local php_version
  php_version=$(get_php_version "$version")
  local download_file="$download_path/php-${php_version}.tar.gz"
  local download_url
  download_url=$(get_download_url "$install_type" "$version")

  echo "Downloading PHP source from $download_url"
  curl -Lo "$download_file" "$download_url"

  echo "Extracting PHP source..."
  tar -xzf "$download_file" -C "$download_path" --strip-components=1

  # Clean up tarball
  rm -f "$download_file"
}

download_source "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_DOWNLOAD_PATH"
