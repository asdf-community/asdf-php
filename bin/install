#!/usr/bin/env bash
set -eo pipefail

# Get the plugin root directory
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Setup php-build
PHP_BUILD_ROOT="$PLUGIN_DIR/vendor/php-build"

# Check if php-build exists, if not try to initialize submodule
if [ ! -f "$PHP_BUILD_ROOT/bin/php-build" ]; then
  echo "php-build not found, attempting to initialize submodule..."

  # Try to initialize the submodule if we're in a git repository
  if [ -d "$PLUGIN_DIR/.git" ] || [ -f "$PLUGIN_DIR/.git" ]; then
    (
      cd "$PLUGIN_DIR"
      git submodule update --init --recursive vendor/php-build
    )
  fi

  # Check again after submodule init
  if [ ! -f "$PHP_BUILD_ROOT/bin/php-build" ]; then
    echo "Error: php-build not found at $PHP_BUILD_ROOT"
    echo ""
    echo "This plugin requires php-build to be available."
    echo ""
    echo "If you cloned this plugin, run:"
    echo "  cd $PLUGIN_DIR"
    echo "  git submodule update --init --recursive"
    echo ""
    echo "If you used 'asdf plugin add php <local-path>', please reinstall using:"
    echo "  asdf plugin remove php"
    echo "  asdf plugin add php https://github.com/asdf-community/asdf-php.git"
    exit 1
  fi
fi

export PATH="$PHP_BUILD_ROOT/bin:$PATH"

# Extract version from ASDF variables
version="${ASDF_INSTALL_VERSION}"
install_path="${ASDF_INSTALL_PATH}"

# Handle "latest" version resolution
if [ "$version" = "latest" ]; then
  version=$("${PLUGIN_DIR}/bin/latest-stable")
  echo "Resolved 'latest' to version $version"
fi

# Check OpenSSL version and PHP version compatibility
check_openssl_compatibility() {
  local php_version=$1

  # Get system OpenSSL version
  if ! command -v openssl &> /dev/null; then
    echo "⚠ Warning: OpenSSL not found in PATH"
    return 0
  fi

  local openssl_full_version=$(openssl version 2>/dev/null | awk '{print $2}')
  local openssl_major=$(echo "$openssl_full_version" | cut -d. -f1)

  # Only check if OpenSSL 3.x is detected
  if [ "$openssl_major" -lt 3 ]; then
    return 0
  fi

  # Extract PHP version components
  local php_major=$(echo "$php_version" | cut -d. -f1)
  local php_minor=$(echo "$php_version" | cut -d. -f2)
  local php_patch=$(echo "$php_version" | cut -d. -f3 | sed 's/[^0-9].*//')

  # Determine if this PHP version needs OpenSSL 1.1
  local needs_openssl1=false
  local php_status=""
  local has_other_issues=false

  if [ "$php_major" -eq 7 ]; then
    needs_openssl1=true
    php_status="PHP 7.x (End of Life)"
  elif [ "$php_major" -eq 8 ] && [ "$php_minor" -eq 0 ]; then
    if [ "$php_patch" -lt 20 ]; then
      needs_openssl1=true
      php_status="PHP 8.0.0-8.0.19"
      # PHP 8.0.0-8.0.5 have additional compatibility issues
      if [ "$php_patch" -lt 6 ]; then
        has_other_issues=true
      fi
    fi
  elif [ "$php_major" -eq 8 ] && [ "$php_minor" -eq 1 ]; then
    if [ "$php_patch" -lt 6 ]; then
      needs_openssl1=true
      php_status="PHP 8.1.0-8.1.5"
    fi
  fi

  if [ "$needs_openssl1" != true ]; then
    return 0
  fi

  # Display compatibility warning
  echo "⚠ PHP ${php_version} incompatible with OpenSSL ${openssl_full_version}"

  # Warn about other compatibility issues
  if [ "$has_other_issues" = true ]; then
    echo "⚠ PHP 8.0.0-8.0.5 have additional compatibility issues with modern systems"
    echo "  Recommended: Use PHP 8.0.30 (latest 8.0.x) instead"
  fi

  # Try to find existing OpenSSL 1.1 installation
  local openssl11_paths=(
    "$HOME/.local/openssl-1.1"
    "/usr/local/openssl-1.1"
    "/usr/local/openssl@1.1"
    "/usr/local/opt/openssl@1.1"
    "/opt/openssl-1.1"
    "/usr/lib64/openssl11"
  )

  local openssl11_path=""
  for path in "${openssl11_paths[@]}"; do
    if [ -f "$path/bin/openssl" ]; then
      openssl11_path="$path"
      break
    fi
  done

  if [ -n "$openssl11_path" ]; then
    # Found OpenSSL 1.1 - configure build to use it
    local found_version=$(LD_LIBRARY_PATH="${openssl11_path}/lib:${LD_LIBRARY_PATH}" "$openssl11_path/bin/openssl" version 2>/dev/null | awk '{print $2}')
    echo "✓ Using OpenSSL 1.1 (${found_version}) at ${openssl11_path}"
    export PKG_CONFIG_PATH="${openssl11_path}/lib/pkgconfig:${PKG_CONFIG_PATH}"
    export PHP_BUILD_CONFIGURE_OPTS="${PHP_BUILD_CONFIGURE_OPTS} --with-openssl=${openssl11_path}"
    export OPENSSL_CFLAGS="-I${openssl11_path}/include"
    export OPENSSL_LIBS="-L${openssl11_path}/lib -lssl -lcrypto"
    export LD_LIBRARY_PATH="${openssl11_path}/lib:${LD_LIBRARY_PATH}"
  else
    # OpenSSL 1.1 not found - offer to install
    echo "✗ OpenSSL 1.1 not found"
    echo ""
    echo "php-build's OpenSSL 3 patch is incomplete for PHP ${php_version}."
    echo "OpenSSL 1.1 is required to build this PHP version."
    echo ""
    read -p "Install OpenSSL 1.1 automatically? [y/N] " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
      echo "Installing OpenSSL 1.1..."
      if "${PLUGIN_DIR}/lib/install-openssl11.sh" --auto; then
        echo ""
        echo "✓ OpenSSL 1.1 installed successfully"
        echo "Configuring build to use OpenSSL 1.1..."

        # Set environment variables for this build
        openssl11_path="${INSTALL_PREFIX:-$HOME/.local/openssl-1.1}"
        export PKG_CONFIG_PATH="${openssl11_path}/lib/pkgconfig:${PKG_CONFIG_PATH}"
        export PHP_BUILD_CONFIGURE_OPTS="${PHP_BUILD_CONFIGURE_OPTS} --with-openssl=${openssl11_path}"
        export OPENSSL_CFLAGS="-I${openssl11_path}/include"
        export OPENSSL_LIBS="-L${openssl11_path}/lib -lssl -lcrypto"
        export LD_LIBRARY_PATH="${openssl11_path}/lib:${LD_LIBRARY_PATH}"
        echo ""
      else
        echo "✗ OpenSSL 1.1 installation failed"
        exit 1
      fi
    else
      echo ""
      echo "Cannot proceed without OpenSSL 1.1."
      echo "To install manually, run: ${PLUGIN_DIR}/lib/install-openssl11.sh"
      echo ""
      exit 1
    fi
  fi
}

# Check compatibility before building
check_openssl_compatibility "$version"

# Add compiler flags for PHP 7.4 and early PHP 8.0 to handle modern compiler strictness
php_major=$(echo "$version" | cut -d. -f1)
php_minor=$(echo "$version" | cut -d. -f2)
php_patch=$(echo "$version" | cut -d. -f3 | sed 's/[^0-9].*//')

if [ "$php_major" -eq 7 ] && [ "$php_minor" -eq 4 ]; then
  # Disable errors for shadowing and other warnings that fail on modern compilers
  export CFLAGS="${CFLAGS:-} -Wno-error=shadow -Wno-error=implicit-function-declaration"
  export PHP_BUILD_CONFIGURE_OPTS="${PHP_BUILD_CONFIGURE_OPTS} --disable-werror"
elif [ "$php_major" -eq 8 ] && [ "$php_minor" -eq 0 ] && [ "$php_patch" -lt 20 ]; then
  # PHP 8.0.0-8.0.19 have calloc-transposed-args and other warnings treated as errors
  export CFLAGS="${CFLAGS:-} -Wno-error=calloc-transposed-args -Wno-error=deprecated-declarations"
  export PHP_BUILD_CONFIGURE_OPTS="${PHP_BUILD_CONFIGURE_OPTS} --disable-werror"
fi

# Disable Xdebug by default (prevents build failures)
if [ -z "$PHP_BUILD_XDEBUG_ENABLE" ]; then
  export PHP_BUILD_XDEBUG_ENABLE=off
fi

# Pass through custom configure options
if [ -n "$PHP_CONFIGURE_OPTIONS" ]; then
  export PHP_BUILD_CONFIGURE_OPTS="${PHP_BUILD_CONFIGURE_OPTS:-} ${PHP_CONFIGURE_OPTIONS}"
fi

# Pass through PEAR option
if [ "${PHP_WITHOUT_PEAR:-no}" != "no" ]; then
  export PHP_BUILD_CONFIGURE_OPTS="${PHP_BUILD_CONFIGURE_OPTS} --without-pear"
fi

# Pass through concurrency settings
if [ -n "$ASDF_CONCURRENCY" ]; then
  export PHP_BUILD_EXTRA_MAKE_ARGUMENTS="-j${ASDF_CONCURRENCY}"
fi

# Patch php-build definition files to include libxml2 compatibility
patch_php_build_definitions() {
  local php_version=$1
  local php_major=$(echo "$php_version" | cut -d. -f1)
  local php_minor=$(echo "$php_version" | cut -d. -f2)
  local php_patch=$(echo "$php_version" | cut -d. -f3 | sed 's/[^0-9].*//')
  local php_build_patches="$PHP_BUILD_ROOT/share/php-build/patches"
  local definitions_dir="$PHP_BUILD_ROOT/share/php-build/definitions"
  local def_file="$definitions_dir/$php_version"

  # Add libxml2 2.12+ and ICU 74+ compatibility patches for PHP 7.4
  if [ "$php_major" -eq 7 ] && [ "$php_minor" -eq 4 ]; then
    # libxml2 2.12+ patch (php-build already has it)
    if [ -f "$def_file" ] && ! grep -q "php-7.4-libxml2-2.12.patch" "$def_file"; then
      # Add after the last patch_file line, or before install_package if no patches exist
      if grep -q "patch_file" "$def_file"; then
        # Find the last patch_file line and add after it
        local last_patch_line=$(grep -n "patch_file" "$def_file" | tail -1 | cut -d: -f1)
        sed -i "${last_patch_line}a patch_file \"php-7.4-libxml2-2.12.patch\"" "$def_file"
      else
        # Add before install_package
        sed -i '/^install_package/i patch_file "php-7.4-libxml2-2.12.patch"\n' "$def_file"
      fi
      echo "Added libxml2 compatibility patch to PHP $php_version definition"
    fi

    # ICU 74+ patch (custom patch from plugin)
    if [ -f "${PLUGIN_DIR}/patches/php-7.4-icu-74-compat.patch" ]; then
      cp "${PLUGIN_DIR}/patches/php-7.4-icu-74-compat.patch" "$php_build_patches/"
      if [ -f "$def_file" ] && ! grep -q "php-7.4-icu-74-compat.patch" "$def_file"; then
        local last_patch_line=$(grep -n "patch_file" "$def_file" | tail -1 | cut -d: -f1)
        sed -i "${last_patch_line}a patch_file \"php-7.4-icu-74-compat.patch\"" "$def_file"
        echo "Added ICU 74+ compatibility patch to PHP $php_version definition"
      fi
    fi
  fi

  # Add libxml2 2.12+ and ICU 74+ compatibility patches for PHP 8.0.0-8.0.19
  if [ "$php_major" -eq 8 ] && [ "$php_minor" -eq 0 ] && [ "$php_patch" -lt 20 ]; then
    # libxml2 2.12+ patch
    if [ -f "${PLUGIN_DIR}/patches/php-8.0-libxml2-2.12-compat.patch" ]; then
      cp "${PLUGIN_DIR}/patches/php-8.0-libxml2-2.12-compat.patch" "$php_build_patches/"
      if [ -f "$def_file" ] && ! grep -q "php-8.0-libxml2-2.12-compat.patch" "$def_file"; then
        sed -i '/patch_file "php-8.0-support-openssl-3.patch"/a patch_file "php-8.0-libxml2-2.12-compat.patch"' "$def_file"
        echo "Added libxml2 compatibility patch to PHP $php_version definition"
      fi
    fi

    # ICU 74+ patch
    if [ -f "${PLUGIN_DIR}/patches/php-8.0-icu-74-compat.patch" ]; then
      cp "${PLUGIN_DIR}/patches/php-8.0-icu-74-compat.patch" "$php_build_patches/"
      if [ -f "$def_file" ] && ! grep -q "php-8.0-icu-74-compat.patch" "$def_file"; then
        sed -i '/patch_file "php-8.0-libxml2-2.12-compat.patch"/a patch_file "php-8.0-icu-74-compat.patch"' "$def_file"
        echo "Added ICU 74+ compatibility patch to PHP $php_version definition"
      fi
    fi
  fi
}

patch_php_build_definitions "$version"

echo "Building PHP ${version}..."

# Call php-build to do the heavy lifting
if php-build "$version" "$install_path"; then
  echo "✓ PHP ${version} built successfully"
else
  echo "✗ Build failed. For OpenSSL issues: ${PLUGIN_DIR}/lib/install-openssl11.sh"
  exit 1
fi

# Install Composer globally (php-build doesn't do this by default)
install_composer() {
  local bin_path="$install_path/bin"
  local expected_signature=$(curl -sL https://composer.github.io/installer.sig)

  $bin_path/php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" 2>/dev/null
  $bin_path/php -r "if (hash_file('sha384', 'composer-setup.php') === '${expected_signature}') { echo 'OK'; } else { unlink('composer-setup.php'); exit(1); }" > /dev/null
  $bin_path/php composer-setup.php --install-dir="$bin_path" --filename=composer --quiet
  $bin_path/php -r "unlink('composer-setup.php');" 2>/dev/null
}

# Install Composer
echo "Installing Composer..."
if install_composer; then
  echo "✓ Composer installed"
else
  echo "⚠ Composer installation failed"
fi

# Create conf.d directory for user configuration
mkdir -p "$install_path/conf.d"
if [ ! -f "$install_path/conf.d/php.ini" ]; then
  echo "# Add custom PHP configuration here" > "$install_path/conf.d/php.ini"
fi

# Install Xdebug if requested
install_xdebug() {
  local bin_path="$install_path/bin"
  local pecl_path="$bin_path/pecl"

  echo "Installing Xdebug..."
  if ! command -v "$pecl_path" &> /dev/null; then
    echo "⚠ PECL not found"
    return 1
  fi

  if "$pecl_path" install xdebug > /dev/null 2>&1; then
    echo "zend_extension=xdebug.so" >> "$install_path/conf.d/xdebug.ini"
    echo "xdebug.mode=debug" >> "$install_path/conf.d/xdebug.ini"
    echo "✓ Xdebug installed"
  else
    echo "⚠ Xdebug installation failed"
    return 1
  fi
}

# Check if user wants Xdebug installed
if [ "${PHP_WITH_XDEBUG:-no}" != "no" ]; then
  install_xdebug || true
fi

echo "✓ PHP ${version} installed at: ${install_path}"
