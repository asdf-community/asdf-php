#!/usr/bin/env bash

set -euo pipefail

# Get all versions and filter for stable releases only
# Stable releases are in the format X.Y.Z without any alpha, beta, RC, or other suffixes

sort_versions() {
  sed 'h; s/[+-]/./g; s/.p\([[:digit:]]\)/.z\1/; s/$/.z/; G; s/\n/ /' |
    LC_ALL=C sort -t. -k 1,1 -k 2,2n -k 3,3n -k 4,4n -k 5,5n | awk '{print $2}'
}

# Fetch all tags from PHP repository
versions=$(
  git ls-remote --tags https://github.com/php/php-src.git |
    grep 'php-' |
    awk '!/(\{.*\})/ {print $2}' |
    sed 's/refs\/tags\/php-//' |
    grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' |
    sort_versions
)

# Get the latest version from the sorted list
latest_version=$(echo "$versions" | tail -n 1)

# If a query version is provided (e.g., "8.4"), filter to that major.minor
if [ $# -eq 1 ] && [ -n "$1" ]; then
  query="$1"
  # Extract matching versions for the given major.minor
  filtered_versions=$(echo "$versions" | grep -E "^${query}\." || echo "")

  if [ -n "$filtered_versions" ]; then
    latest_version=$(echo "$filtered_versions" | tail -n 1)
  else
    # If no match found, return nothing (asdf will handle the error)
    exit 1
  fi
fi

echo "$latest_version"
